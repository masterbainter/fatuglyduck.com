<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hartford Rummage Checklist</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2322c55e'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1zm-1.5-6.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5z'/%3E%3C/svg%3E">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .filter-btn.active { background-color: #22c55e; color: white; }
        .achievement-modal { display: none; }
        .achievement-modal.show { display: flex; }
        .achievement-icon { filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.4)); }
        .achievement-card { opacity: 0.3; filter: grayscale(80%); }
        .achievement-card.unlocked { opacity: 1; filter: grayscale(0%); }
        #toast-notification {
            transform: translateY(200%);
            transition: transform 0.3s ease-in-out;
        }
        #toast-notification.show {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app" class="p-4">
        <header class="text-center mb-6">
            <div class="mb-4">
                <img src="https://www.hartfordsd.us/repository/designs/templates/GO_hartford_sd_2023_resp/images/title.png" alt="Hartford Logo" class="h-16 w-auto mx-auto">
            </div>
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">
                Hartford Rummage Checklist
            </h1>
            <p class="text-base text-gray-400">
                Your guide to the 2025 city-wide sales.
            </p>
            <div class="mt-4 space-y-1">
                <div id="progress-counter" class="text-lg font-semibold text-green-400">Loading...</div>
                <div id="visitor-counter" class="text-sm font-medium text-cyan-400"><span class="animate-pulse">Connecting...</span></div>
            </div>
        </header>

        <!-- Achievements Section -->
        <div id="achievements-section" class="mb-8 text-center">
             <h2 class="text-xl font-bold text-white mb-3">Your Awards</h2>
             <div id="achievements-container" class="flex justify-center items-center gap-4 sm:gap-6">
                 <!-- Achievement icons will be inserted here -->
             </div>
        </div>

        <!-- Filter buttons -->
        <div id="filter-container" class="flex justify-center items-center gap-2 mb-6 flex-wrap">
            <button data-filter="all" class="filter-btn px-4 py-2 text-sm font-semibold rounded-full transition-colors duration-200 bg-gray-700 text-gray-300 hover:bg-gray-600 active">All Sales</button>
            <button data-filter="open" class="filter-btn px-4 py-2 text-sm font-semibold rounded-full transition-colors duration-200 bg-gray-700 text-gray-300 hover:bg-gray-600">Open Today</button>
            <button data-filter="not_visited" class="filter-btn px-4 py-2 text-sm font-semibold rounded-full transition-colors duration-200 bg-gray-700 text-gray-300 hover:bg-gray-600">Not Visited</button>
        </div>
        
        <div id="loading-indicator" class="text-center text-xl text-gray-400">Loading your checklist...</div>

        <main id="sales-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Rummage sale cards will be injected here -->
        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-xs">
            <p>Your progress is saved automatically to this device.</p>
        </footer>
    </div>

    <!-- Achievement Unlocked Modal -->
    <div id="achievement-modal" class="achievement-modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 z-50">
        <div class="bg-gray-800 border-2 border-yellow-400 rounded-xl p-6 text-center max-w-sm w-full transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-yellow-300 mb-2">Achievement Unlocked!</h2>
            <div id="modal-achievement-icon" class="text-6xl my-4"></div>
            <h3 id="modal-achievement-name" class="text-xl font-semibold text-white"></h3>
            <p id="modal-achievement-message" class="text-gray-400 mt-2 mb-6"></p>
            <button id="close-modal-btn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600 transition-colors">Awesome!</button>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-red-500 text-white text-sm font-bold py-2 px-4 rounded-full shadow-lg">
        <!-- Toast message here -->
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Data with Geolocation ---
        const rummageSalesData = [
            { id: 1, address: "301 w 7th st", lat: 43.6230, lng: -96.9452, days: "Friday, Saturday", thursday: "N/a", friday: "8 am", saturday: "8 am", items: "Porcelain Dolls, kids clothes, kids toys, household items, men's camo clothing" },
            { id: 2, address: "512 S. Main Ave, Hartford", lat: 43.6190, lng: -96.9439, days: "Thursday, Friday, Saturday", thursday: "1 PM", friday: "8 AM", saturday: "8 AM", items: "Antique dishes & items, household items, TV's, outdoor decor, kitchen gadgets, photo & scrapbook albums, many more items too numerous to list" },
            { id: 3, address: "804 Par Tee Dr. Hartford SD 57033", lat: 43.6268, lng: -96.9587, days: "Thursday, Friday, Saturday", thursday: "4pm", friday: "8:30am", saturday: "8:00 AM", items: "Adult clothing, teen clothing, boys clothing sz8-10, lots of miscellaneous- home decor, toys etc" },
            { id: 4, address: "817 Ruud ln 26", lat: 43.6289, lng: -96.9535, days: "Thursday, Friday, Saturday", thursday: "8am", friday: "8am", saturday: "8am", additionalDays: "Wednesday 3pm-8pm", items: "Fishing/ice fishing equipment, Tools, Namebrand shoes/clothes, A little bit of everything" },
            { id: 5, address: "203 Mary Ln", lat: 43.6253, lng: -96.9379, days: "Thursday, Friday, Saturday", thursday: "12-8", friday: "12-8", saturday: "8-12", items: "Multi family, many household items, women and men’s clothing, and home decor" },
            { id: 6, address: "46514 Kloxin Drive Hartford SD", lat: 43.6214, lng: -96.9213, days: "Thursday, Friday", thursday: "8:00am - 5:00pm", friday: "8:00am - 5:00pm", saturday: "N/A", items: "Clothing, krumkake iron, 4 counter stools, toys, lamp, misc." },
            { id: 7, address: "408 S Western Ave (St.George Catholic Church)", lat: 43.6201, lng: -96.9482, days: "Friday, Saturday", thursday: "N/A", friday: "8:00 am", saturday: "8:00 am", items: "Baby items, childrens clothing, furnature, glassware, antiques adult and teenage clothing." },
            { id: 8, address: "26126 462nd Ave, Hartford", lat: 43.6429, lng: -96.9555, days: "Thursday, Friday, Saturday", thursday: "10-5", friday: "10-6", saturday: "10-2", items: "NEIGHBOR COUNTRY RUMMAGE - worth the 1.25 gravel drive! 2 Couches, Outdoor furniture, Dewalt Scroll Saw + Stand, Name Brand Kitchen items, Large baby items (swing, pac n play, bumbo seat, pumps), Tan garage door (9'W x 8'H), Men, women, and baby clothing and coats, lots more." },
            { id: 9, address: "810 Ruud Lane garage #8", lat: 43.6289, lng: -96.9535, days: "Friday, Saturday", thursday: "N/A", friday: "8am", saturday: "8am", items: "Name brand men’s, women’s clothes and shoes, household items, twin mattress/box spring and frame, end tables, coffee table, lamps, plastic storage shelves, toys, lots of miscellaneous. Good prices, something for everyone." },
            { id: 10, address: "506 W Opal Ln", lat: 43.6320, lng: -96.9490, days: "Thursday, Friday, Saturday", thursday: "3PM", friday: "8AM", saturday: "8AM", items: "LOTS of clothes! Girls NB - 7/8, Womens XL - 3X, Men's XL - 3X. Priced to sell! Toys Galore! Small to Big. Bigger items: Bumper cars, electric car, scooters, toy organizer, book shelf, kitchen, wagon, bikes" },
        ];

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBp3vJ3R4xFtG7UHfv7CbSUl-bZE-5ik0E",
          authDomain: "hartford-rummage2025-fe0f3.firebaseapp.com",
          databaseURL: "https://hartford-rummage2025-fe0f3-default-rtdb.firebaseio.com",
          projectId: "hartford-rummage2025-fe0f3",
          storageBucket: "hartford-rummage2025-fe0f3.appspot.com",
          messagingSenderId: "520958147494",
          appId: "1:520958147494:web:96a455852f231f35a3ad67",
          measurementId: "G-50YZMDWQH8"
        };
        
        // --- Achievements Data ---
        const achievements = [
            { id: 1, name: "Bargain Beginner", threshold: 5, icon: '🥉', message: "You're off to a great start. Keep hunting for those treasures!" },
            { id: 2, name: "Seasoned Scavenger", threshold: 15, icon: '🥈', message: "You've got a keen eye for deals!" },
            { id: 3, name: "Treasure Tracker", threshold: 30, icon: '🥇', message: "A true master of the rummage arts!" },
            { id: 4, name: "Rummage Royalty", threshold: 61, icon: '🏆', message: "You've conquered them all! Behold, the ultimate rummager!" }
        ];

        // --- App State ---
        let completedLocations = [];
        let verifiedLocations = []; // For achievements
        let unlockedAchievements = [];
        let currentFilter = 'all';

        // --- DOM Elements ---
        const salesContainer = document.getElementById('sales-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const progressCounter = document.getElementById('progress-counter');
        const filterContainer = document.getElementById('filter-container');
        const visitorCounter = document.getElementById('visitor-counter');
        const achievementsContainer = document.getElementById('achievements-container');
        const modal = document.getElementById('achievement-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const toast = document.getElementById('toast-notification');
        
        // --- Helper Functions ---
        const isSaleOpenToday = (sale) => {
            const dayMap = { 0: 'sunday', 1: 'monday', 2: 'tuesday', 3: 'wednesday', 4: 'thursday', 5: 'friday', 6: 'saturday' };
            const today = new Date();
            const todayName = dayMap[today.getDay()];
            const saleDays = (sale.days || '').toLowerCase();
            const additional = (sale.additionalDays || '').toLowerCase();
            return saleDays.includes(todayName) || additional.includes(todayName);
        };
        
        function getDistanceInMeters(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // in metres
        }
        
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `fixed bottom-5 left-1/2 -translate-x-1/2 text-white text-sm font-bold py-2 px-4 rounded-full shadow-lg ${isError ? 'bg-red-500' : 'bg-blue-500'}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- Achievements Logic ---
        function renderAchievements() {
            achievementsContainer.innerHTML = '';
            achievements.forEach(ach => {
                const isUnlocked = unlockedAchievements.includes(ach.id);
                const card = document.createElement('div');
                card.className = `achievement-card p-2 rounded-lg transition-all duration-300 ${isUnlocked ? 'unlocked' : ''}`;
                card.innerHTML = `
                    <div class="text-4xl achievement-icon">${ach.icon}</div>
                    <div class="text-xs font-semibold mt-1">${ach.name}</div>
                `;
                achievementsContainer.appendChild(card);
            });
        }

        function showAchievementModal(achievement) {
             document.getElementById('modal-achievement-icon').textContent = achievement.icon;
             document.getElementById('modal-achievement-name').textContent = achievement.name;
             document.getElementById('modal-achievement-message').textContent = achievement.message;
             modal.classList.add('show');
             setTimeout(() => modal.querySelector('.transform').classList.remove('scale-95', 'opacity-0'), 10);
        }

        function hideAchievementModal() {
             modal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
             setTimeout(() => modal.classList.remove('show'), 200);
        }

        function checkAchievements() {
            const verifiedCount = verifiedLocations.length;
            const newlyUnlocked = achievements.find(ach => 
                verifiedCount >= ach.threshold && !unlockedAchievements.includes(ach.id)
            );

            if (newlyUnlocked) {
                unlockedAchievements.push(newlyUnlocked.id);
                localStorage.setItem('hartfordRummageAchievements2025', JSON.stringify(unlockedAchievements));
                renderAchievements();
                showAchievementModal(newlyUnlocked);
            }
        }
        
        // --- Core Application Logic ---
        function renderSales() {
            const filteredSales = rummageSalesData.filter(sale => {
                if (currentFilter === 'not_visited') return !completedLocations.includes(sale.id);
                if (currentFilter === 'open') return isSaleOpenToday(sale);
                return true;
            });
            salesContainer.innerHTML = '';
            loadingIndicator.style.display = 'none';
            filteredSales.forEach(sale => {
                const isCompleted = completedLocations.includes(sale.id);
                const card = document.createElement('div');
                card.className = `relative bg-gray-800 border border-gray-700 rounded-lg p-4 transition-all duration-300 flex flex-col ${isCompleted ? 'opacity-50' : 'opacity-100'}`;
                card.innerHTML = `
                    <div class="absolute top-3 right-3">
                        <button data-id="${sale.id}" class="toggle-complete w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-300 z-10 ${isCompleted ? 'bg-green-500 text-white' : 'bg-gray-700 hover:bg-green-600 text-gray-400'}" aria-label="Mark ${sale.address} as visited">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                    </div>
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg mb-2 text-green-400 pr-10 ${isCompleted ? 'line-through' : ''}">${sale.address}</h3>
                        ${isSaleOpenToday(sale) ? `<div class="absolute top-3 left-3 bg-yellow-500 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full">OPEN TODAY</div>` : ''}
                        <p class="text-gray-400 text-sm mb-3"><strong>Sale Days:</strong> ${sale.days}</p>
                        <div class="grid grid-cols-3 gap-2 text-center mb-4 text-xs sm:text-sm">
                            <div class="bg-gray-700/50 p-2 rounded-md"><p class="font-semibold text-gray-300">Thursday</p><p class="text-gray-400">${sale.thursday}</p></div>
                            <div class="bg-gray-700/50 p-2 rounded-md"><p class="font-semibold text-gray-300">Friday</p><p class="text-gray-400">${sale.friday}</p></div>
                            <div class="bg-gray-700/50 p-2 rounded-md"><p class="font-semibold text-gray-300">Saturday</p><p class="text-gray-400">${sale.saturday}</p></div>
                        </div>
                        ${(sale.additionalDays && !['na', 'n/a'].includes(sale.additionalDays.toLowerCase())) ? `<p class="text-xs sm:text-sm text-yellow-400 mb-3"><strong>Extra Days:</strong> ${sale.additionalDays}</p>` : ''}
                        <div class="bg-gray-900/70 p-3 rounded-md mt-auto">
                            <p class="text-gray-300 font-semibold mb-1 text-sm">Items for Sale:</p>
                            <p class="text-gray-400 text-xs sm:text-sm">${sale.items}</p>
                        </div>
                    </div>`;
                salesContainer.appendChild(card);
            });
            updateProgressCounter();
        }

        function updateProgressCounter() {
            progressCounter.textContent = `${completedLocations.length} / ${rummageSalesData.length} Visited`;
        }

        function handleToggleComplete(locationId) {
            // First, visually check it off immediately for good UX
            if (!completedLocations.includes(locationId)) {
                completedLocations.push(locationId);
            } else {
                 // Un-checking doesn't need verification
                completedLocations = completedLocations.filter(id => id !== locationId);
                verifiedLocations = verifiedLocations.filter(id => id !== locationId);
                localStorage.setItem('hartfordRummageChecklist2025', JSON.stringify(completedLocations));
                localStorage.setItem('hartfordRummageVerified2025', JSON.stringify(verifiedLocations));
                renderSales();
                return;
            }
            localStorage.setItem('hartfordRummageChecklist2025', JSON.stringify(completedLocations));
            renderSales();

            // Then, try to verify for achievement
            const sale = rummageSalesData.find(s => s.id === locationId);
            navigator.geolocation.getCurrentPosition(
                (position) => { // Success callback
                    const distance = getDistanceInMeters(
                        position.coords.latitude,
                        position.coords.longitude,
                        sale.lat,
                        sale.lng
                    );

                    // Allow about half a mile radius for verification
                    if (distance < 805) { 
                        if (!verifiedLocations.includes(locationId)) {
                             verifiedLocations.push(locationId);
                             localStorage.setItem('hartfordRummageVerified2025', JSON.stringify(verifiedLocations));
                             showToast("Visit Verified!", false);
                             checkAchievements();
                        }
                    } else {
                        showToast("Too far away to verify for award.", true);
                    }
                },
                (error) => { // Error callback
                    showToast("Could not get location. Visit not verified for award.", true);
                }
            );
        }
        
        function setupPresenceSystem(auth) {
             onAuthStateChanged(auth, (user) => {
                if (user) {
                    const rtdb = getDatabase();
                    const appId = firebaseConfig.projectId;
                    const uid = user.uid;
                    const userStatusDatabaseRef = ref(rtdb, `/artifacts/${appId}/public/presence/users/${uid}`);
                    const connectedRef = ref(rtdb, '.info/connected');
                    const allUsersRef = ref(rtdb, `/artifacts/${appId}/public/presence/users`);

                    onValue(connectedRef, (snap) => {
                        if (snap.val() === true) { set(userStatusDatabaseRef, true); onDisconnect(userStatusDatabaseRef).remove(); }
                    });
                    
                    onValue(allUsersRef, (snap) => {
                        const count = snap.size; 
                        visitorCounter.innerHTML = `<span class="flex items-center justify-center"><span class="relative flex h-3 w-3 mr-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-cyan-500"></span></span>${count} Live Visitor${count === 1 ? '' : 's'}</span>`;
                    });
                }
            });
        }

        // --- Event Listeners ---
        filterContainer.addEventListener('click', (e) => {
            if (e.target.matches('.filter-btn')) {
                const filterType = e.target.dataset.filter;
                if (filterType === currentFilter) return;
                filterContainer.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                currentFilter = filterType;
                renderSales();
            }
        });
        salesContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.toggle-complete');
            if (button) {
                handleToggleComplete(parseInt(button.dataset.id, 10));
            }
        });
        closeModalBtn.addEventListener('click', hideAchievementModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) hideAchievementModal(); });

        // --- Initialization ---
        function main() {
            try {
                const savedChecklist = localStorage.getItem('hartfordRummageChecklist2025');
                if (savedChecklist) completedLocations = JSON.parse(savedChecklist);
                const savedVerified = localStorage.getItem('hartfordRummageVerified2025');
                if (savedVerified) verifiedLocations = JSON.parse(savedVerified);
                const savedAchievements = localStorage.getItem('hartfordRummageAchievements2025');
                if (savedAchievements) unlockedAchievements = JSON.parse(savedAchievements);
            } catch (e) { console.error("Could not parse saved data", e); }
            
            renderSales();
            renderAchievements();

            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                setupPresenceSystem(auth);
                signInAnonymously(auth).catch(err => {
                    console.error("Anonymous sign-in for visitor counter failed:", err);
                    visitorCounter.textContent = "Visitor count disabled";
                });
            } catch (error) {
                console.error("Firebase Initialization for visitor counter failed:", error);
                visitorCounter.textContent = "Offline";
            }
        }
        
        main();
    </script>
</body>
</html>
